# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1x_HBsp9o9RPOh-b7f_2Tb93y-M6i7c-w
"""

import streamlit as st
import pandas as pd
import numpy as np
import glob
from joblib import load
import random
import time
import os
import zipfile
from utils import load_models, load_feature_lists, load_model_performances, prepare_input_data, make_predictions

# Sayfa yapılandırması
st.set_page_config(
    page_title="Nörogelişimsel Bozukluk Tarama Sistemi",
    page_icon="🧠",
    layout="wide"
)

# CSS stilleri
st.markdown("""
<style>
    .main {
        padding: 2rem;
    }
    .stButton > button {
        width: 100%;
        margin-top: 1rem;
    }
    .result-box {
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
    .high-risk {
        background-color: rgba(255, 0, 0, 0.1);
        border: 1px solid red;
    }
    .medium-risk {
        background-color: rgba(255, 165, 0, 0.1);
        border: 1px solid orange;
    }
    .low-risk {
        background-color: rgba(0, 255, 0, 0.1);
        border: 1px solid green;
    }
</style>
""", unsafe_allow_html=True)

# Başlık
st.title("🧠 Nörogelişimsel Bozukluk Tarama Sistemi")

# Session state başlatma
if 'models' not in st.session_state:
    try:
        st.session_state.models = load_models()
        st.session_state.feature_lists = load_feature_lists()
        st.session_state.performances = load_model_performances()
        st.session_state.questions_df = pd.read_csv("cevaplar600.csv")
    except Exception as e:
        st.error(f"Dosyalar yüklenirken hata oluştu: {str(e)}")
        st.stop()

# Yan panel - Kullanım bilgileri
with st.sidebar:
    st.header("📋 Kullanım Bilgileri")
    st.markdown("""
    1. Soruları dikkatlice okuyun
    2. Her soru için en uygun cevabı seçin
    3. Tüm soruları yanıtladıktan sonra 'Değerlendir' butonuna tıklayın
    4. Sistem size risk değerlendirmesini gösterecektir
    
    **Not:** Bu sistem bir ön değerlendirme aracıdır ve kesin tanı koyamaz. 
    Mutlaka bir uzmana danışınız.
    """)
    
    st.markdown("---")
    st.markdown("### 🎯 Risk Seviyeleri")
    st.markdown("""
    - 🔴 Yüksek Risk: > 75%
    - 🟡 Orta Risk: 50-75%
    - 🟢 Düşük Risk: < 50%
    """)

# Ana panel - Sorular
st.header("📝 Değerlendirme Formu")

# Soruları göster
user_answers = {}
for _, row in st.session_state.questions_df.iterrows():
    question_id = row['ID']
    question_text = row['Soru']
    
    # Her soru için radio buton oluştur
    answer = st.radio(
        f"**{question_id}. {question_text}**",
        options=["Hiçbir Zaman", "Bazen", "Sık Sık", "Her Zaman"],
        horizontal=True,
        key=f"q_{question_id}"
    )
    
    # Cevabı sayısal değere çevir
    user_answers[question_id] = {"Hiçbir Zaman": 0, "Bazen": 1, "Sık Sık": 2, "Her Zaman": 3}[answer]
    
    st.markdown("---")

# Değerlendirme butonu
if st.button("💫 Değerlendir", type="primary"):
    with st.spinner("Değerlendirme yapılıyor..."):
        try:
            # Verileri hazırla ve tahmin yap
            prepared_data = prepare_input_data(user_answers, st.session_state.feature_lists)
            predictions = make_predictions(
                st.session_state.models,
                prepared_data,
                st.session_state.performances
            )
            
            # Sonuçları göster
            st.header("🎯 Değerlendirme Sonuçları")
            
            for disease, prob in predictions.items():
                # Risk seviyesini belirle
                if prob > 0.75:
                    risk_class = "high-risk"
                    risk_text = "Yüksek Risk 🔴"
                elif prob > 0.50:
                    risk_class = "medium-risk"
                    risk_text = "Orta Risk 🟡"
                else:
                    risk_class = "low-risk"
                    risk_text = "Düşük Risk 🟢"
                
                # Sonucu göster
                st.markdown(f"""
                <div class="{risk_class} result-box">
                    <h3>{disease}</h3>
                    <p><b>Risk Seviyesi:</b> {risk_text}</p>
                    <p><b>Risk Oranı:</b> {prob:.1%}</p>
                </div>
                """, unsafe_allow_html=True)
            
            # Uyarı notu
            st.warning("""
            ⚠️ **Önemli Not:** Bu sonuçlar sadece bir ön değerlendirmedir ve kesin tanı yerine geçmez. 
            Lütfen detaylı değerlendirme için bir uzmana başvurunuz.
            """)
            
        except Exception as e:
            st.error(f"Değerlendirme sırasında bir hata oluştu: {str(e)}")