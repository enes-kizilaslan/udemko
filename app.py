# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1x_HBsp9o9RPOh-b7f_2Tb93y-M6i7c-w
"""

import streamlit as st
import pandas as pd
import numpy as np
import glob
from joblib import load
import random
import time
import os
import zipfile
from utils import load_models, load_feature_lists, load_model_performances, prepare_input_data, make_predictions

# Sayfa yap캼land캼rmas캼
st.set_page_config(
    page_title="N칬rogeli를msel Bozukluk Tarama Sistemi",
    page_icon="游",
    layout="wide"
)

# CSS stilleri
st.markdown("""
<style>
    .main {
        padding: 2rem;
    }
    .stButton > button {
        width: 100%;
        margin-top: 1rem;
    }
    .result-box {
        padding: 1rem;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
    .high-risk {
        background-color: rgba(255, 0, 0, 0.1);
        border: 1px solid red;
    }
    .medium-risk {
        background-color: rgba(255, 165, 0, 0.1);
        border: 1px solid orange;
    }
    .low-risk {
        background-color: rgba(0, 255, 0, 0.1);
        border: 1px solid green;
    }
</style>
""", unsafe_allow_html=True)

# Ba륿캼k
st.title("游 N칬rogeli를msel Bozukluk Tarama Sistemi")

# Session state ba륿atma
if 'models' not in st.session_state:
    try:
        st.session_state.models = load_models()
        st.session_state.feature_lists = load_feature_lists()
        st.session_state.performances = load_model_performances()
        st.session_state.questions_df = pd.read_csv("cevaplar600.csv")
    except Exception as e:
        st.error(f"Dosyalar y칲klenirken hata olu릆u: {str(e)}")
        st.stop()

# Yan panel - Kullan캼m bilgileri
with st.sidebar:
    st.header("游늶 Kullan캼m Bilgileri")
    st.markdown("""
    1. Sorular캼 dikkatlice okuyun
    2. Her soru i칞in en uygun cevab캼 se칞in
    3. T칲m sorular캼 yan캼tlad캼ktan sonra 'De른rlendir' butonuna t캼klay캼n
    4. Sistem size risk de른rlendirmesini g칬sterecektir
    
    **Not:** Bu sistem bir 칬n de른rlendirme arac캼d캼r ve kesin tan캼 koyamaz. 
    Mutlaka bir uzmana dan캼캼n캼z.
    """)
    
    st.markdown("---")
    st.markdown("### 游꿢 Risk Seviyeleri")
    st.markdown("""
    - 游댮 Y칲ksek Risk: > 75%
    - 游리 Orta Risk: 50-75%
    - 游릭 D칲칲k Risk: < 50%
    """)

# Ana panel - Sorular
st.header("游닇 De른rlendirme Formu")

# Sorular캼 g칬ster
user_answers = {}
for _, row in st.session_state.questions_df.iterrows():
    question_id = row['ID']
    question_text = row['Soru']
    
    # Her soru i칞in radio buton olu릆ur
    answer = st.radio(
        f"**{question_id}. {question_text}**",
        options=["Hi칞bir Zaman", "Bazen", "S캼k S캼k", "Her Zaman"],
        horizontal=True,
        key=f"q_{question_id}"
    )
    
    # Cevab캼 say캼sal de른re 칞evir
    user_answers[question_id] = {"Hi칞bir Zaman": 0, "Bazen": 1, "S캼k S캼k": 2, "Her Zaman": 3}[answer]
    
    st.markdown("---")

# De른rlendirme butonu
if st.button("游눪 De른rlendir", type="primary"):
    with st.spinner("De른rlendirme yap캼l캼yor..."):
        try:
            # Verileri haz캼rla ve tahmin yap
            prepared_data = prepare_input_data(user_answers, st.session_state.feature_lists)
            predictions = make_predictions(
                st.session_state.models,
                prepared_data,
                st.session_state.performances
            )
            
            # Sonu칞lar캼 g칬ster
            st.header("游꿢 De른rlendirme Sonu칞lar캼")
            
            for disease, prob in predictions.items():
                # Risk seviyesini belirle
                if prob > 0.75:
                    risk_class = "high-risk"
                    risk_text = "Y칲ksek Risk 游댮"
                elif prob > 0.50:
                    risk_class = "medium-risk"
                    risk_text = "Orta Risk 游리"
                else:
                    risk_class = "low-risk"
                    risk_text = "D칲칲k Risk 游릭"
                
                # Sonucu g칬ster
                st.markdown(f"""
                <div class="{risk_class} result-box">
                    <h3>{disease}</h3>
                    <p><b>Risk Seviyesi:</b> {risk_text}</p>
                    <p><b>Risk Oran캼:</b> {prob:.1%}</p>
                </div>
                """, unsafe_allow_html=True)
            
            # Uyar캼 notu
            st.warning("""
            丘멆잺 **칐nemli Not:** Bu sonu칞lar sadece bir 칬n de른rlendirmedir ve kesin tan캼 yerine ge칞mez. 
            L칲tfen detayl캼 de른rlendirme i칞in bir uzmana ba릈urunuz.
            """)
            
        except Exception as e:
            st.error(f"De른rlendirme s캼ras캼nda bir hata olu릆u: {str(e)}")